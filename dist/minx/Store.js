!function(l){var e=l.Class({events:["init","validate","before","success","error","complete","after"],properties:{url:null,data:null,method:"POST",headers:null},methods:{init:function(e,t,r,n){this.sets({url:e,data:t,method:r,headers:n}),this.fire("init",this.gets())},validateArgv:function(e,t,r,n){return{url:e||this._url||"",data:t||this._data||{},method:r||this._method||"POST",headers:n||this._headers||{}}},exec:function(e,t,r,n){var i=this.validateArgv(e,t,r,n),s=l.store.fire("before",i);return!1!==s&&(!1!==(s=this.fire("before",i))&&i)},__onComplete:function(e){var t=l.store.fire("after",e);return!1!==t&&(!1!==(t=this.fire("complete",e))&&void 0)},__onSuccess:function(e,t){var r=l.store.fire("success",e,t);return!1!==r&&(!1!==(r=this.fire("success",e,t))&&void 0)},__onError:function(e){var t=l.store.fire("success",e);return!1!==t&&(!1!==(t=this.fire("success",e))&&void 0)},refresh:function(e,t,r,n){return this.exec(e,t,r,n)},clone:function(e){var t=this._data;return t="object"==typeof t?l.extend(JSON.parse(JSON.stringify(t)),e):e,new this.constructor(this._url,t,this._method,this._headers)},extend:function(e){return this._data=l.extend(this._data,e),this},overwrite:function(e){return this._data=l.overwrite(this._data,e),this}}}),t=l.Class(e,{methods:{init:function(e,t,r,n){this.sets({url:e,data:t,method:r,headers:n}),this.fire("init",this.gets())},exec:function(e,t,r,n){var i=this.validateArgv(e,t,r,n),s=l.store.fire("before",i);return!1!==s&&(!1!==(s=this.fire("before",i))&&(!1!==i&&l.http[i.method.toLowerCase()]({url:i.url,data:i.data,headers:i.headers,success:function(e,t,r){this.__onSuccess(t,r)}.bind(this),error:function(e,t){this.__onError(t)}.bind(this),complete:function(e,t){this.__onComplete(t)}.bind(this)})))}}}),r=l.Class(e,{methods:{init:function(e,t,r,n){this.sets({url:e,data:t,method:r,headers:n}),this.fire("init",this.gets())},exec:function(e,t,r,n){var i=this.validateArgv(e,t,r,n),s=l.store.fire("before",i);if(!1===s)return!1;if(!1===(s=this.fire("before",i)))return!1;if(!1===i)return!1;var o=i.url,a=i.method,u=i.data,h=i.headers,c=this,f={method:a.toUpperCase()};switch(a.toUpperCase()){case"POST":var d=new FormData;for(var _ in u)d.append(_,u[_]);f.body=d,f.headers=l.overwrite(h,{Accept:"multipart/form-data","Content-Type":"multipart/form-data; charset=UTF-8"});break;case"GET":var v=[];l.each(u,function(e,t){v.push(t+"="+e)}),o+="?"+v.join("&");break;case"JSON":f.body=JSON.stringify(u),f.method="POST",f.headers=l.overwrite(h,{Accept:"multipart/form-data","Content-Type":"multipart/form-data; charset=UTF-8"})}return new Promise(function(t,r){fetch(l.http.fixURL(o),f).then(function(e){return e.json()}).then(function(e){c.__onSuccess(e),c.__onComplete(e),t(e)}).catch(function(e){c.__onError(e),c.__onComplete(e),r(e)})})}}}),n=l.Class({events:["init","before","after"],properties:{data:null,argv:{set:function(e){this._argv=e},get:function(){return this._argv||{}}}},methods:{init:function(e,t){this.reset(e,t),this.fire("init",this)},reset:function(e,t){return e&&(this._data=e),t&&(this._argv=t),this._argv&&this._argv.autoLoad&&this.exec(),this},refresh:function(){return this.exec(),this},exec:function(){var r=this._data,n=this;return!!r&&(!1!==(this._argv.onExec&&this._argv.onExec(r))&&(!1!==this.fire("before",r)&&(r.__id__?void r.on("success",function(e,t){t=n._argv.dataHandler&&n._argv.dataHandler(t)||t,n._argv.onSuccess&&n._argv.onSuccess(t)}).on("error",function(e,t){n._argv.onError&&n._argv.onError(t)}).on("complete",function(e,t){n._argv.onComplete&&n._argv.onComplete(t)}).exec():new Promise(function(e,t){if(r){if(r=n._argv.dataHandler&&n._argv.dataHandler(r)||r,!1===l.store.fire("success",r))return!1;n._argv.onSuccess&&n._argv.onSuccess(r),n._argv.onComplete&&n._argv.onComplete(r),e(r)}else{if(!(r="this._data is undefined.")===l.store.fire("error",r))return!1;n._argv.onError&&n._argv.onError(r),n._argv.onComplete&&n._argv.onComplete(r),t(r)}}))))}}}),i=l.Class({events:["before","success","error","complete","after"],properties:{engine:{set:function(e){this._engine=e},get:function(){return"Fetcher"==this._engine?r:t}}},methods:{fixURL:function(e){return l.http.fixURL(e)},dataSource:function(e,t){return new n(e,t)},request:function(e,t,r,n){return new this.engine(e,t,r,n)},post:function(e,t,r){return this.request(e,t,"POST",r)},delete:function(e,t,r){return this.request(e,t,"DELETE",r)},put:function(e,t,r){return this.request(e,t,"PUT",r)},get:function(e,t,r){return this.request(e,t,"GET",r)}}});l.store=l.GLOBAL.Store=new i}(zn);